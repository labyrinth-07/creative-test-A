<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>气球派对</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.0/p5.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { margin: 0; padding: 0; overflow: hidden; background: #FAFAFA; font-family: 'Microsoft YaHei', sans-serif; }
        canvas { display: block; position: fixed; top: 0; left: 0; z-index: 1 !important; }

        #setup-overlay {
            position: fixed; top: 20px; left: 20px; width: 340px;
            background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px);
            z-index: 100; border-radius: 20px; padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1); border: 1px solid rgba(0,0,0,0.05);
            transition: 0.4s ease;
        }

        .palette { display: flex; gap: 12px; margin: 15px 0; }
        .color-dot {
            width: 45px; height: 45px; border-radius: 12px; cursor: pointer;
            border: 3px solid #eee; transition: 0.2s; position: relative;
        }
        .color-dot.active { border-color: #000; transform: scale(1.1); box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        .color-dot.active::after { content: '✓'; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: white; font-weight: bold; text-shadow: 0 0 3px #000; }

        #aut-ui {
            display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            z-index: 99; width: 450px; text-align: center;
            background: rgba(255, 255, 255, 0.6); backdrop-filter: blur(15px);
            padding: 40px; border-radius: 30px; border: 1px solid rgba(255,255,255,0.3);
            box-shadow: 0 20px 50px rgba(0,0,0,0.1);
        }

        #aut-input { width: 100%; padding: 18px; border: 2px solid #000; border-radius: 15px; font-size: 20px; outline: none; margin-top: 20px; background: rgba(255,255,255,0.8); }
        #start-btn { width: 100%; background: #000; color: white; border: none; padding: 15px; font-size: 16px; cursor: pointer; border-radius: 50px; font-weight: bold; margin-top: 10px; transition: 0.3s; }
        #start-btn:hover { background: #333; transform: scale(1.02); }
        .hidden { opacity: 0; pointer-events: none; transform: translateX(-50px); }
    </style>
</head>
<body>

<div id="setup-overlay">
    <div style="text-align: left; margin-bottom: 25px; border-bottom: 1px solid rgba(0,0,0,0.1); padding-bottom: 15px;">
        <p style="font-size: 13px; color: #666; line-height: 1.6; margin: 0;">
            欢迎参加。在此环节，你可以通过上传音乐和调节颜色构建<b>“欢乐情境”</b>。请在调整满意后，点击下方按钮开始测试。请尽可能多地写出物品的功能。
        </p>
    </div>
    <h2 style="margin-top:0; font-size: 18px;">环境自定义</h2>
    <p style="font-size:14px; color:#666;">1. 上传本地音乐 (.mp3)</p>
    <input type="file" id="audio-file" accept="audio/*" style="font-size:12px; margin-bottom:20px;">

    <p style="font-size:14px; color:#666;">2. 选择组件颜色 (可多选)</p>
    <div class="palette">
        <div class="color-dot active" style="background: #FF4081;" data-color="#FF4081"></div>
        <div class="color-dot" style="background: #76FF03;" data-color="#76FF03"></div>
        <div class="color-dot" style="background: #FFEB3B;" data-color="#FFEB3B"></div>
        <div class="color-dot" style="background: #40C4FF;" data-color="#40C4FF"></div>
    </div>
    <p style="font-size:11px; color:#999;">* 再次点击已选颜色可取消选中</p>

    <button id="start-btn">确认环境并答题</button>
</div>

<div id="aut-ui">
    <h2 id="item-display" style="margin:0; font-size:32px;">物品：玻璃</h2>
    <p id="timer-display" style="font-weight:bold; font-size:28px; margin:15px 0; color: #FF4081;">180s</p>
    <input type="text" id="aut-input" placeholder="输入用途后回车提交...">
    <div style="margin-top:20px; color:#555; font-size:14px; display:flex; justify-content:space-between;">
        <span id="progress-text">进度：1 / 3</span>
        <span>已提交: <span id="ans-count" style="font-weight:bold;">0</span></span>
    </div>
    <button id="next-item-btn" style="margin-top:25px; background:none; border:none; color:#666; text-decoration:underline; cursor:pointer;">跳到下一个物品</button>
</div>

<script>
const _supabase = supabase.createClient('https://ebqbvpjvwdewgjlxuwrf.supabase.co', 'sb_publishable_VWUOQouThmiW18KA_bIahw_nG_Dfubu');

let items = ["玻璃", "任意款式包包", "牙线"], currentItemIdx = 0, answers = [], timeLeft = 180, timer;
let isRunning = false;
let selectedColors = ['#FF4081'];
let shapes = [];
let audioContext, analyser, dataArray, audioEl;
let uploadedFileName = "未命名音乐";

function setup() {
    let cnv = createCanvas(windowWidth, windowHeight);
    cnv.style('position', 'fixed'); cnv.style('top', '0'); cnv.style('left', '0'); cnv.style('z-index', '1');
    shapes.push(new CartoonSpeaker());
}

function draw() {
    background(252);
    let energy = 0;
    if (analyser) {
        analyser.getByteFrequencyData(dataArray);
        let sum = 0; for(let i=0; i<16; i++) sum += dataArray[i];
        energy = (sum / 16) / 255;
    }
    for (let i = shapes.length - 1; i >= 0; i--) {
        shapes[i].update(energy); shapes[i].draw();
        if (shapes[i] instanceof Balloon && shapes[i].dead) shapes.splice(i, 1);
    }
    if (shapes.length < 18 && random(1) > 0.95) {
        shapes.push(new Balloon());
    }
}

async function initAudio(file) {
    if (audioContext) audioContext.close();
    audioContext = new (window.AudioContext || window.webkitAudioContext)();
    analyser = audioContext.createAnalyser(); analyser.fftSize = 256;
    dataArray = new Uint8Array(analyser.frequencyBinCount);
    if (audioEl) audioEl.remove();
    audioEl = new Audio(); audioEl.src = URL.createObjectURL(file); audioEl.loop = true;
    let source = audioContext.createMediaElementSource(audioEl);
    source.connect(analyser); analyser.connect(audioContext.destination);
    await audioEl.play();
}

class CartoonSpeaker {
    constructor() { this.w = 150; this.h = 180; this.bounce = 0; }
    update(energy) {
        this.bounce = energy * 40;
        this.x = width - this.w - 50;
        this.y = height - this.h - 50;
    }
    draw() {
        push(); translate(this.x + this.w/2, this.y + this.h/2);
        scale(1 + this.bounce * 0.005);
        fill(40); noStroke(); rect(-this.w/2, -this.h/2, this.w, this.h, 25);
        fill(selectedColors.length > 0 ? selectedColors[0] : '#ccc');
        circle(0, 20, 110 + this.bounce);
        fill(20); circle(0, 20, 30);
        pop();
    }
}

class Balloon {
    constructor() {
        this.r = 30 + random(40); this.x = random(width); this.y = height + this.r;
        this.speed = 1.2 + random(2); this.offset = random(100); this.dead = false;
        this.dynamicScale = 0;
        let baseColor = selectedColors.length > 0 ? random(selectedColors) : '#FF4081';
        let c = color(baseColor);
        this.color = color(red(c), green(c), blue(c), random(160, 240));
    }
    update(energy) {
        this.dynamicScale = energy * 15;
        this.y -= (this.speed + (energy * 2));
        this.x += sin(this.y * 0.01 + this.offset) * 0.5;
        if (this.y < -150) this.dead = true;
    }
    draw() {
        push(); translate(this.x, this.y);
        scale(1 + this.dynamicScale * 0.01);
        fill(this.color); noStroke();
        ellipse(0, 0, this.r * 1.8, this.r * 2);
        fill(255, 255, 255, 80); ellipse(-this.r * 0.3, -this.r * 0.3, this.r * 0.4, this.r * 0.2);
        pop();
    }
}

document.querySelectorAll('.color-dot').forEach(dot => {
    dot.onclick = () => {
        const color = dot.getAttribute('data-color');
        if (dot.classList.contains('active')) {
            if (selectedColors.length <= 1) return;
            dot.classList.remove('active');
            selectedColors = selectedColors.filter(c => c !== color);
        } else {
            dot.classList.add('active');
            selectedColors.push(color);
        }
        document.getElementById('timer-display').style.color = selectedColors[0];
    };
});

document.getElementById('start-btn').onclick = async function() {
    let fileEl = document.getElementById('audio-file');
    let file = fileEl.files[0];
    if (!file) return alert("请先上传本地音乐！");

    uploadedFileName = file.name;
    const btn = this; btn.disabled = true;

    try {
        await initAudio(file);
        const { data } = await _supabase.from('Participants').insert([{ group_tag: 'C1' }]).select();
        window.currentParticipantId = data[0].id;

        // 隐藏配置面板并显示答题面板
        const overlay = document.getElementById('setup-overlay');
        overlay.classList.add('hidden');
        setTimeout(() => overlay.style.display = 'none', 400);

        document.getElementById('aut-ui').style.display = 'block';
        isRunning = true;
        startItemSession();
    } catch (err) { alert("启动失败"); btn.disabled = false; }
};

function startItemSession() {
    timeLeft = 180;
    document.getElementById('item-display').innerText = `物品：${items[currentItemIdx]}`;
    document.getElementById('timer-display').innerText = `剩余时间: ${timeLeft}s`;
    document.getElementById('progress-text').innerText = `进度：${currentItemIdx + 1} / 3`;
    document.getElementById('ans-count').innerText = answers.filter(a => a.item === items[currentItemIdx]).length;

    setTimeout(() => document.getElementById('aut-input').focus(), 100);
    if(timer) clearInterval(timer);
    timer = setInterval(() => {
        timeLeft--;
        document.getElementById('timer-display').innerText = `剩余时间: ${timeLeft}s`;
        if (timeLeft <= 0) switchNextItem();
    }, 1000);
}

function switchNextItem() {
    if (currentItemIdx < items.length - 1) {
        currentItemIdx++;
        startItemSession();
    } else {
        finishAndUpload();
    }
}

document.getElementById('aut-input').onkeypress = (e) => {
    if (e.key === 'Enter' && e.target.value.trim() !== "") {
        answers.push({ item: items[currentItemIdx], response: e.target.value.trim() });
        e.target.value = "";
        let count = answers.filter(a => a.item === items[currentItemIdx]).length;
        document.getElementById('ans-count').innerText = count;
    }
};

async function finishAndUpload() {
    clearInterval(timer); if (audioEl) audioEl.pause();
    const ui = document.getElementById('aut-ui');
    ui.innerHTML = "<h3>数据提交中...</h3>";
    await _supabase.from('experiment_results_A').insert([{
        participant_id: window.currentParticipantId,
        is_customized: true,
        mode_type: "HH-C",
        music_genre: "歌名: " + uploadedFileName + " | 颜色: " + selectedColors.join(','),
        fluency_score: answers.length,
        user_answers: JSON.stringify(answers)
    }]);
    ui.innerHTML = `<h3 style='color:green;'>上传成功！实验结束。</h3>`;
}

function windowResized() { resizeCanvas(windowWidth, windowHeight); }

document.getElementById('next-item-btn').onclick = () => {
    if(confirm("确定要跳到下一个物品吗？")) {
        switchNextItem();
    }
};
</script>
</body>
</html>