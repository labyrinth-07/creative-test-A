<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>模式 1: 欢乐派对</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { margin: 0; padding: 0; overflow: hidden; background: #FAFAFA; font-family: 'Microsoft YaHei', sans-serif; user-select: none; }
        canvas { display: block; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; z-index: 1; }

        /* 启动界面 */
        #setup-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.95); z-index: 100;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            pointer-events: auto; text-align: center; padding: 20px;
        }

        /* 初始禁用的按钮样式：灰色 */
        #start-btn {
            background: #ccc; color: #666; border: none; padding: 15px 50px; font-size: 18px;
            letter-spacing: 1px; cursor: not-allowed; border-radius: 50px; font-weight: bold;
            margin-top: 30px; transition: 0.3s;
        }

        /* 加载完成后的激活样式：粉红色 */
        #start-btn.ready {
            background: #FF4081; color: white; cursor: pointer;
            box-shadow: 0 5px 15px rgba(255, 64, 129, 0.3);
        }
        #start-btn.ready:hover { transform: scale(1.05); background: #f50057; }

        .header-info h1 { font-size: 42px; color: #333; margin: 0; }
        .header-info p { margin: 15px auto; opacity: 0.8; font-weight: 500; max-width: 600px; line-height: 1.6; font-size: 18px; }

        /* 答题面板 - 透明毛玻璃 */
        #aut-ui {
            display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            z-index: 9999; background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
            padding: 40px; border-radius: 20px; width: 450px; text-align: center;
            box-shadow: 0 20px 50px rgba(0,0,0,0.1); border: 1px solid rgba(255,255,255,0.4);
            pointer-events: auto;
        }
        #aut-input { width: 100%; padding: 15px; border: 2px solid #FF4081; border-radius: 10px; font-size: 18px; outline: none; box-sizing: border-box; margin-top: 20px; background: rgba(255,255,255,0.8); }
        #next-item-btn { margin-top:25px; background:none; border:none; color:#bbb; text-decoration:underline; cursor:pointer; }
    </style>
</head>
<body>

<div id="setup-overlay">
    <div class="header-info">
        <h1>欢乐模式</h1>
        <p>本实验依据于 Alternative Uses Task，将会测试你在欢乐情境下的创造力。<br>
           请针对展示的物品，在有限时间内尽可能多地说出它的用途，越多越好。</p>
        <p id="load-status" style="color: #FF4081; font-size: 14px;">正在同步远程音频资源，请稍候...</p>
    </div>
    <button id="start-btn" disabled>资源加载中...</button>
</div>

<div id="aut-ui">
    <h2 id="item-display" style="color:#333; margin:0; font-size:28px;">物品：砖头</h2>
    <p id="timer-display" style="color:#FF4081; font-weight:bold; font-size:26px; margin:15px 0;">剩余时间: 180s</p>
    <input type="text" id="aut-input" placeholder="输入一种用途，按回车提交...">
    <div style="margin-top:20px; color:#888; font-size:14px; display:flex; justify-content:space-between;">
        <span id="progress-text">进度：1 / 3</span>
        <span>已提交: <span id="ans-count" style="color:#FF4081; font-weight:bold;">0</span></span>
    </div>
    <button id="next-item-btn">跳到下一个物品</button>
</div>

<canvas id="canvas"></canvas>
<audio id="bgm-player" loop></audio>

<script>
const _supabase = supabase.createClient(
    'https://ebqbvpjvwdewgjlxuwrf.supabase.co',
    'sb_publishable_VWUOQouThmiW18KA_bIahw_nG_Dfubu'
);

const items = ["砖头", "回形针", "毛毯"];
let currentItemIdx = 0, answers = [], timeLeft = 180, timer;

const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
let shapes = [];
const config = { width: window.innerWidth, height: window.innerHeight };

function resize() { config.width = canvas.width = window.innerWidth; config.height = canvas.height = window.innerHeight; }
window.addEventListener('resize', resize);
resize();

// --- 视觉动画类 ---
class CartoonSpeaker {
    constructor() { this.w = 150; this.h = 180; this.update(0); this.bounce = 0; }
    update(energy) { this.bounce = energy * 20; this.x = config.width - this.w - 50; this.y = config.height - this.h - 50; }
    draw(ctx) {
        ctx.save(); ctx.translate(this.x + this.w/2, this.y + this.h/2);
        const scale = 1 + this.bounce * 0.005; ctx.scale(scale, scale);
        ctx.fillStyle = '#333';
        if (ctx.roundRect) ctx.roundRect(-this.w/2, -this.h/2, this.w, this.h, 20); else ctx.rect(-this.w/2, -this.h/2, this.w, this.h);
        ctx.fill();
        const wooferSize = 50 + this.bounce;
        ctx.fillStyle = '#222'; ctx.beginPath(); ctx.arc(0, 20, 60, 0, Math.PI*2); ctx.fill();
        ctx.fillStyle = '#444'; ctx.beginPath(); ctx.arc(0, 20, wooferSize, 0, Math.PI*2); ctx.fill();
        ctx.fillStyle = '#111'; ctx.beginPath(); ctx.arc(0, 20, wooferSize * 0.3, 0, Math.PI*2); ctx.fill();
        ctx.fillStyle = '#555'; ctx.beginPath(); ctx.arc(0, -50, 20, 0, Math.PI*2); ctx.fill();
        if (this.bounce > 8) { ctx.strokeStyle = '#FF4081'; ctx.lineWidth = 3 + this.bounce * 0.1; ctx.beginPath(); ctx.arc(0, 20, wooferSize + 10, 0, Math.PI*2); ctx.stroke(); }
        ctx.restore();
    }
}

class Balloon {
    constructor() {
        this.r = 30 + Math.random() * 40; this.x = Math.random() * config.width;
        this.y = config.height + this.r; this.speed = 1.0 + Math.random() * 2;
        this.color = ['#FF4081', '#40C4FF', '#E040FB', '#FFEB3B', '#76FF03'][Math.floor(Math.random()*5)];
        this.offset = Math.random()*100; this.dead = false;
    }
    update() { this.y -= this.speed; this.x += Math.sin(this.y * 0.01 + this.offset) * 0.5; if (this.y < -100) this.dead = true; }
    draw(ctx) {
        ctx.fillStyle = this.color; ctx.beginPath(); ctx.ellipse(this.x, this.y, this.r*0.9, this.r, 0, 0, Math.PI*2); ctx.fill();
        ctx.fillStyle = 'rgba(255,255,255,0.3)'; ctx.beginPath(); ctx.ellipse(this.x - this.r*0.3, this.y - this.r*0.3, this.r*0.2, this.r*0.1, -0.5, 0, Math.PI*2); ctx.fill();
    }
}

// --- 音频逻辑：预加载监听 ---
let audioCtx, analyser, dataArray, sourceNode;
const audioPlayer = document.getElementById('bgm-player');
const startBtn = document.getElementById('start-btn');
const loadStatus = document.getElementById('load-status');

// 核心优化：监听音频元数据加载和缓冲
audioPlayer.src = "1.mp3";
audioPlayer.addEventListener('canplaythrough', () => {
    startBtn.innerText = "开始实验";
    startBtn.classList.add('ready');
    startBtn.disabled = false;
    loadStatus.innerText = "音频就绪，系统已同步。";
    loadStatus.style.color = "#4CAF50";
}, { once: true });

function initAudio() {
    if(!audioCtx) {
        const AC = window.AudioContext || window.webkitAudioContext;
        audioCtx = new AC(); analyser = audioCtx.createAnalyser();
        analyser.fftSize = 256;
        dataArray = new Uint8Array(analyser.frequencyBinCount);
        sourceNode = audioCtx.createMediaElementSource(audioPlayer);
        sourceNode.connect(analyser);
        analyser.connect(audioCtx.destination);
    }
    audioPlayer.play();
}

function loop() {
    let bassEnergy = 0;
    if (analyser && !audioPlayer.paused) { analyser.getByteFrequencyData(dataArray); bassEnergy = dataArray[5] / 255; }
    ctx.fillStyle = '#FAFAFA'; ctx.fillRect(0, 0, config.width, config.height);
    for (let i = shapes.length - 1; i >= 0; i--) {
        const s = shapes[i];
        if (s instanceof CartoonSpeaker) s.update(bassEnergy); else s.update();
        s.draw(ctx);
        if (s instanceof Balloon && s.dead) shapes.splice(i, 1);
    }
    if (shapes.length < 15 && Math.random() > 0.96) shapes.push(new Balloon());
    requestAnimationFrame(loop);
}

function startItemSession() {
    timeLeft = 180;
    document.getElementById('item-display').innerText = `物品：${items[currentItemIdx]}`;
    document.getElementById('progress-text').innerText = `进度：${currentItemIdx + 1} / 3`;
    document.getElementById('timer-display').innerText = `剩余时间: ${timeLeft}s`;
    document.getElementById('ans-count').innerText = "0";
    setTimeout(() => { document.getElementById('aut-input').focus(); }, 100);

    if(timer) clearInterval(timer);
    timer = setInterval(() => {
        timeLeft--;
        document.getElementById('timer-display').innerText = `剩余时间: ${timeLeft}s`;
        if (timeLeft <= 0) switchNextItem();
    }, 1000);
}

function switchNextItem() {
    if (currentItemIdx < items.length - 1) {
        currentItemIdx++;
        startItemSession();
    } else {
        finishAndUpload();
    }
}

document.getElementById('aut-input').addEventListener('keypress', (e) => {
    if (e.key === 'Enter' && e.target.value.trim() !== "") {
        answers.push({ item: items[currentItemIdx], response: e.target.value.trim() });
        e.target.value = "";
        let currentItemAnswers = answers.filter(a => a.item === items[currentItemIdx]).length;
        document.getElementById('ans-count').innerText = currentItemAnswers;
    }
});

async function finishAndUpload() {
    clearInterval(timer);
    audioPlayer.pause();
    const ui = document.getElementById('aut-ui');
    ui.innerHTML = "<h3>正在提交实验数据...</h3>";

    // 1. 准备要上传的数据对象
    // 注意：这里的字段名必须与你 Supabase 表中的字段名完全一致
    const uploadData = {
        participant_id: 1, // 暂时固定为1，实际建议从 URL 参数或登录信息获取
        is_customized: true, // 因为当前是“欢乐派对”模式，属于 C 组自选逻辑
        mode_type: "HH", // 高愉悦高激活对应的代码
        music_genre: "欢乐爵士", // 对应你音频的风格
        fluency_score: answers.length, // 自动计算答案总数
        user_answers: JSON.stringify(answers) // 存储详细答案文本
    };

    try {
        // 2. 提交到 experiment_results_A 表
        const { error } = await _supabase
            .from('experiment_results_A')
            .insert([uploadData]);

        if (error) throw error;
        ui.innerHTML = "<h3 style='color:green;'>上传成功！实验结束。</h3>";
    } catch (err) {
        console.error("上传失败:", err);
        ui.innerHTML = `<h3>提交失败: ${err.message}</h3>`;
    }
}

startBtn.addEventListener('click', () => {
    if(!startBtn.classList.contains('ready')) return;
    document.getElementById('setup-overlay').style.display = 'none';
    document.getElementById('aut-ui').style.display = 'block';
    initAudio();
    shapes = [new CartoonSpeaker()];
    loop();
    startItemSession();
});

document.getElementById('next-item-btn').onclick = () => { if(confirm("确定要跳到下一个物品吗？")) switchNextItem(); };
</script>
</body>
</html>